#!/usr/bin/env python3
# This file is placed in the Public Domain.


"main program"


import os
import sys


sys.path.insert(0, os.getcwd())


from rssbot.defines import SYSTEMD, CLI, Commands, Config, Message
from rssbot.defines import command, enable
from rssbot.defines import banner, forever, pidname, wrap, wrapped
from rssbot.defines import boot, check, modules, init, scanner
from rssbot.defines import daemon, pidfile, privileges


import rssbot.modules as MODS


Config.ignore = ""
Config.level = "info"
Config.name = "rssbot" 
Config.txt = " ".join(sys.argv[1:])
Config.version = 658


class Line(CLI):

    def raw(self, text):
        "write to console."
        print(text.encode('utf-8', 'replace').decode("utf-8"))


class Console(Line):

    def callback(self, event):
        "wait for callback result."
        if not event.text:
            return
        super().callback(event)
        event.wait()

    def poll(self):
        "poll for inpput."
        evt = Message()
        evt.text = input("> ")
        evt.kind = "command"
        return evt


def background():
    "background script."
    daemon(check("v"), check("m"))
    privileges()
    boot(Config.txt, MODS)
    pidfile(pidname(Config.name))
    enable(cmd, mod, ver)
    scanner(modules())
    init(modules())
    forever()


def console():
    "console script."
    import readline
    readline.redisplay()
    if check("0"):
        Config.ignore = list()
    boot(Config.txt, MODS)
    if "v" in Config.opts:
        banner()
    scanner()
    enable(cmd, mod, ver)
    if "a" in Config.opts:
        mds = modules()
    else:
        mds = Config.sets.init
    init(mds, "w" in Config.opts)
    csl = Console()
    csl.start()
    forever()


def control():
    "cli script."
    if len(sys.argv) == 1:
        return
    boot(Config.txt, MODS)
    scanner()
    enable(cmd, mod, srv, ver)
    cli = Line()
    evt = Message()
    evt.orig = repr(cli)
    evt.text = " ".join(sys.argv[1:])
    evt.type = "command"
    command(evt)
    evt.wait()


def service():
    "service script."
    privileges()
    boot(Config.txt, MODS)
    banner()
    pidfile(pidname(Config.name))
    enable(cmd, mod, ver)
    scanner()
    init(modules())
    forever()


def cmd(event):
    "list available commands."
    event.reply(",".join(sorted(Commands.names or Commands.cmds)))


def mod(event):
    "list available commands."
    event.reply(modules())


def srv(event):
    "generate systemd service file."
    import getpass
    name = getpass.getuser()
    event.reply(SYSTEMD % (Config.name.upper(), name, name, name, Config.name))


def ver(event):
    "show version."
    event.reply(f"{Config.name.upper()} {Config.version} {Config.opts}")


def main():
    "runtime."
    if check('z'):
        Config.debug = True
    if check("c"):
        wrap(console)
    elif check("d"):
        background()
    elif check("s"):
        wrapped(service)
    else:
        wrapped(control)


if __name__ == "__main__":
    main()
