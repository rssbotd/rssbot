#!/usr/bin/env python3
# This file is placed in the Public Domain.
# pylint: disable=C,W0212


"daemon"


import os
import sys
import time
import _thread


from rssbot.modules import irc, rss
from rssbot.persist import Workdir, pidfile, pidname
from rssbot.runtime import later, launch


Workdir.wdr = os.path.expanduser("~/.rssbot")


def forever():
    while True:
        try:
            time.sleep(0.1)
        except (KeyboardInterrupt, EOFError):
            _thread.interrupt_main()


def privileges():
    import getpass
    import pwd
    pwnam2 = pwd.getpwnam(getpass.getuser())
    os.setgid(pwnam2.pw_gid)
    os.setuid(pwnam2.pw_uid)


def wrap(func):
    try:
        func()
    except (KeyboardInterrupt, EOFError):
        pass
    except Exception as ex:
        later(ex)


def main():
    privileges()
    pidfile(pidname("rssbot"))
    irc.init()
    rss.init()
    forever()


if __name__ == "__main__":
    wrap(main)
